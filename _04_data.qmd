# Data

### Project Data Ideation

In this section, we address the significant lack of publicly available housing data, which has posed considerable challenges for our research. Although we successfully integrated ten years of Redfin data with demographic and economic indicators, there remain several critical data points we were unable to obtain. Notably, data extending beyond ten years, historical land prices, construction costs, and timelines for housing development were inaccessible. These gaps represent missed opportunities that could have enhanced the comprehensiveness of our dataset.

During our literature review, we compiled a list of desired data features and attempted to locate them online. However, our searches frequently reached a dead end, especially on state websites. While Oregon provides data through PDF reports, there is no user-friendly repository, such as downloadable CSV files or APIs, offering access to extensive historical data. This limitation hindered our ability to create a more robust dataset for our analysis.

### Data Acquisition

The acquisition of housing data proved challenging, particularly due to the restrictive nature of companies like Zillow in sharing their data. Consequently, we turned to Redfin, which offered the most comprehensive data on house sales. To augment our dataset and incorporate the “affordability” aspect of our research, we included national mortgage rates, median income, population, and estimated housing units per county.

Several sources, such as census.gov, provide APIs for data access. However, we found it more practical to use their table explorer to download CSV files. The sheer volume of variables on census.gov necessitates an advanced search mechanism, including an AI-assisted search tool that offers intelligent data suggestions based on user queries. Once the desired table configuration is achieved, the tool can generate an API call for future data retrieval. Although this feature is beneficial for obtaining up-to-date data, it was not essential for our current project.

We encountered a variety of data formats from different sources, which necessitated significant data cleaning and preparation. A notable challenge was managing data provided as separate files for each year, resulting in an extensive number of files for our ten-year study period. To streamline this process, we concatenated these files, which involved transposing tables and manual data manipulation. We later automated this process with a Python script to make it more efficient.

Standardizing county names and removing extraneous characters, such as dollar signs from prices, were additional tasks required to harmonize the dataset. Despite these challenges, the data was generally well-structured. The final dataset, categorized by the level of temporal and geographical granularity, is detailed in the <a href="capstone.html#data-dictionary">Data Dictionary</a> below. This structured approach facilitated the integration of diverse data sources into a cohesive Postgres database, enabling a thorough analysis of housing affordability in Oregon.

#### Data Sources

###### Housing Data - Redfin Data Center

Redfin provides a comprehensive dataset accessible through its data center, offering both graphical representations and downloadable files. The dataset spans from 2012 to the present and allows for geographic filtering specific to Oregon counties. We extracted data for all available years, encompassing all property types, and used raw values rather than year-over-year comparisons or seasonally adjusted figures.

###### Demographic Data

* The American Community Survey (ACS) 5-year estimates, conducted by the U.S. Census Bureau, offer extensive demographic data on various aspects of life in U.S. communities. From this source, we obtained county-level estimates for median income, rental vacancy rates, property taxes, and the number of housing units per year. 
* Historical population estimates for each county were sourced from the Portland State University Population Research Center. 
* The U.S. Department of Housing and Urban Development (HUD) user website provided yearly 50th percentile rent estimates for each county. For our analysis, we utilized the 2-bedroom rental estimates for each county and year.

###### Economic Indicator

The Federal Reserve Bank of St. Louis offers a robust collection of economic data, from which we obtained historical national data on 30-year mortgage rates. While county or state-level mortgage rate data was unavailable, we posited that state-level figures would approximate the national averages, with similar trends observable across the data.

By integrating these diverse datasets, our research aims to comprehensively examine housing affordability trends in Oregon, leveraging detailed demographic and economic indicators to provide a nuanced analysis.


### Data Dictionary
- A housing unit is a house, an apartment, a mobile home, a group of rooms, or a single room that is occupied (or if vacant, is intended for occupancy) as separate living quarters. Separate living quarters are those in which the occupants live and eat separately from any other persons in the building and which have direct access from the outside of the building or through a common hall.


::: {.callout-note collapse="true"}
#### Data Dictionary - Features, Descriptions, and Sources (Click to Expand) 
| Feature              	 | Description                                                                                                                                                                                                 	 |
|------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `county`               	 | Oregon county                                                                                                                                                                                               	 |
| `date`                 	 | Date in yyyy/mm/dd format                                                                                                                                                                                     |
| `inventory`            	 | Total number of active listings on the market on the last day of the time period.                                                                                                                           	 |
| `median_sale_price`    	 | The median final sale price of homes that sold during a given time period                                                                                                                                   	 |
| `homes_sold`           	 | Count of closed home sales during a given time period                                                                                                                                                       	 |
| `new_listings`        	 | Total number of homes listed for sale during a given time period                                                                                                                                            	 |
| `days_on_market`       	 | The median number of days homes that went under contract during a given time period spent on the market before going under contract                                                                         	 |
| `average_sale_to_list` 	 | A measurement of how close the typical home's final price was to its original list price.  It is calcualted as an average of the ratio each home sold during a given period price divided by its list price 	 |
:Table 1 - Redfin Data, Monthly By County, **All features provided by <a href="https://www.redfin.com/news/data-center/" target="_blank">Redfin DataCenter</a>**

<br><br>

| Feature              	          | Description                                           	                    | Source                                                                                                                                    |
|---------------------------------|----------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| `county`               	        | Oregon county                                                              | All table sources                                                                                                                         |
| `year`                	         | Date sampled or calculated in yyyy format                                  | All table sources                                                                                                                         |
| `median_income`                 | Estimated median income per county - inflation adjusted US Dollars         | <a href="https://data.census.gov/table/ACSST5Y2019.S1901?q=median%20income%20oregon%20counties" target="_blank">Census variable S1901</a> |
| `median_rent_2bdrm`    	        | Median rent for a 2 bedroom dwelling                                       | <a href="https://www.huduser.gov/portal/datasets/50per.html" target="_blank">HUDuser.gov</a>                                              |
| `num_housing_units`           	 | Estimated total number of housing units per county                         | <a href="https://data.census.gov/table?q=B25001%20oregon%20counties" target="_blank">Census variable B25001</a>                           |
| `population`         	          | Estimated population per county                                            | <a href="https://www.pdx.edu/population-research/population-estimate-reports" target="_blank">Portland State Population Research</a>      |
| `rental_vacancy`                | Estimated percentage of rental vacancy rate per county                     | <a href="https://data.census.gov/table?q=CP04%20oregon%20counties" target="_blank">Census variable CP04</a>                               |
| `property_tax`                  | Estimated median real estate tax paid for units with a mortgage per county | <a href="https://data.census.gov/table?q=B25103%20oregon%20counties" target="_blank">Census variable B25103</a>                           |
:Table 2 - Demographic Data By Year and County

<br><br>

| Feature              	                      | Description                                          |
|---------------------------------------------|------------------------------------------------------|
| `date`                	                     | Date in yyyy/mm/dd format                            |
| `monthly_average_mortgage_rate`           	 | National average mortgage rate for a 30 year mortgage |
:Table 3 - National Monthly Mortgage Rate Data - **Feature provided by <a href="https://fred.stlouisfed.org/series/MORTGAGE30US" target="_blank">Federal Reserve Bank St. Louis</a>**

<i><b>All links open in a new tab.</b></i>
:::



### Data Storage 
Upon completing the data acquisition and cleaning processes, we compiled the following CSV files, each containing 10 years of data from 2012 to 2022:

	1.	Oregon Population Estimates per County
	2.	Monthly Average National Mortgage Rates for a 30-Year Mortgage
	3.	Census Estimates for Yearly Income
	4.	Census Estimates for Yearly Number of Housing Units
	5.	Census Estimates for Yearly Rental Vacancy Rates
	6.	Census Estimates for Yearly Real Estate Taxes
	7.	Median Rental Prices for a 2-Bedroom Unit
	8.	Redfin Housing Data

These datasets were imported into temporary tables using an SQL script, facilitating the creation of a comprehensive database through joins based on county and year. The final Entity-Relationship Diagram (ERD) is illustrated in the figure below.

By joining our resulting tables, were able to use this database to create the initial dataset, output to a CSV file, to use for our analysis.

![Data ERD](images/data/erd-updated.png){#fig-erd}


### Feature Engineering
We were able to obtain a number of features related to affordability, including current rental prices, national monthly mortgage rates, median_sales_prices.  These allowed us to
create new variables specifically targeted to affordability.

###### **Reconciling Monthly and Yearly Data**
We noticed odd things when we plotted monthly vs yearly data in our scatter plot graphs.  Our data took on clumped column shapes.  And it did not seem representative of what happens in reality.
A county's median income does not suddently increase from one year to the next, for example.  Many of these variables will be different over smaller increments of time.
While consulting with our project statistician, Hank Ibser, he suggested that smoothing the transition of the yearly variables by taking the average change and cumulatively increasing
(or decreasing) the feature amount over the number of months of county data would be a better way to deal with the features than to leave large jumps from year to year.  This left the question
of what to do with the last year of data, since we do not have numbers beyond 2022.  We decided to average all of the previous deltas and apply that as our step up or down, then
proceeded to multiply that by the number of months of data we had and apply the incremental steps to the original rows.
We smoothed out the transitions in this way for the following variables: `median_income`, `population`, `num_housing_units`, `median_rent_2bdrm`, and `rental_vacancy`.

These feature transitions were smoothed using the following formula:

If year < 2022:
<div text-align="center">$$ mc = \frac{nyv - cyv}{n} $$ </div>
<div text-align="center">$$ \sum_{i = 1}^{n}i{(mc)} $$ </div>

fix this so it explains the anyv

If year = 2022:
<div text-align="center">$$ amc = \frac{\sum_{i = 1}^{j}{mc}}{j} $$ </div>
<div text-align="center">$$ \sum_{i = 1}^{n}i{(mc)} $$ </div>

Where:<br>
<i>n</i> = number of rows of data for the county in a year<br>
<i>nyv</i> = the next year value for the feature<br>
<i>cyv</i> = current year value for the feature<br>
<i>mc</i> = change per 1 month<br>
<i>amc</i> = average month changes for all previous years<br>
<i>j</i> = the number of monthly changes (mc) we calculated for previous years<br>
<i>anyv</i> = average of the all year averages<br>

###### **Monthly Housing Payment**: `monthly_housing_payment`

We then created a variable to hold the median monthly mortgage payment, using the following formula:

<div text-align="center">$$ M = .8P \frac{I(1 + I)^N }{(1 + I)^N − 1} $$</div>

Where:<br>
<i>M</i> = `monthly_housing_payment`<br>
<i>P</i> = `median_sale_price`<br>
<i>I</i> = `monthly_avg_mortgage_rate`<br>
<i>N</i> = 360 (the number of total payments over 30 years)<br>

We made this calculation based on a 20% down payment and a 30-year fixed term.  This is a big assumption, but gives us a baseline to look at affordability.

###### **Monthly Median Income**: `monthly_median_income`

<div text-align="center">$$ mmi = \frac{mi}{12} $$ </div>

Where:<br>
<i>mmi</i> = `monthly_median_income`<br>
<i>mi</i> = `median_income`<br>

###### **Monthly Affordable Housing Payment**: `monthly_affordable_housing_payment`

This feature holds the maximum housing payment considered affordable, based on the HUD's affordability threshold of 30%.
<div text-align="center">
$$ mahp = .3 x mmi $$
</div>

Where:<br>
<i>mahp</i> = `monthly_affordable_housing_payment`<br>
<i>mmi</i> = `median_income`<br>