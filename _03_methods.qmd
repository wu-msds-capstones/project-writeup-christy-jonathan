# Methods

The inputs to housing affordability are complex and, often times, intertwined.

#### Rental vs Home Ownership - An Early Project Decision Point
The aim of this project was to primarily look into unaffordable housing and housing consists, primarily, of 2 kinds
of housed individuals:  those who rent and those who own a home.  To decide if we should be focused on both rental unit prices and current home sales, we looked at the
current affordability strategies and compared them with our data to determine the most immediate need.

#### Evaluation of the current rental situation:
About 33% of Oregonians rent, based on the most up-to-date U.S. Census numbers (Oregon’s Homeownership Rate, n.d.).  We evaluated, `median_rent_2bdrm` vs `monthly_affordable_housing_payment` county-by-county
to assess whether Oregonians are paying an unaffordable amount of rent each month.  You can see in the graph below that rental prices sit comfortably under the maximum affordable threshold.  Becuase of this, we decided to focus
on home sale prices for the rest of our analysis.
<br><br><br>

```{python}
#| label: fig-rent-affordability
#| fig-cap: "Median rent for a 2 bedroom vs Maximum affordable housing price"


import pandas as pd
import plotly.graph_objs as go
import plotly.express as px
from plotly.subplots import make_subplots

# Load the dataset
file_path = 'housing_engineered.csv'
housing_data_engineered = pd.read_csv(file_path)

# Convert the date column to datetime format
housing_data_engineered['date'] = pd.to_datetime(housing_data_engineered['date'])
housing_data_engineered['county'] = housing_data_engineered['county'].apply(lambda x: x.capitalize())

# Get unique list of counties
counties = housing_data_engineered['county'].unique()

# Create initial figure
fig = make_subplots()

# Add traces for the initial county (first county in the list)
initial_county_data = housing_data_engineered[housing_data_engineered['county'] == counties[0]]
fig.add_trace(go.Scatter(x=initial_county_data['date'], y=initial_county_data['median_rent_2bdrm'], mode='lines', name='Median Rent 2 Bedroom'))
fig.add_trace(go.Scatter(x=initial_county_data['date'], y=initial_county_data['monthly_affordable_housing_payment'], mode='lines', name='Monthly Affordable Housing Payment'))

# Update plot sizing
fig.update_layout(
    template="plotly_white",
)

# Update layout with dropdown
dropdown_buttons = [
    {
        'args': [{'y': [housing_data_engineered[housing_data_engineered['county'] == county]['median_rent_2bdrm'],
                        housing_data_engineered[housing_data_engineered['county'] == county]['monthly_affordable_housing_payment']],
                 'x': [housing_data_engineered[housing_data_engineered['county'] == county]['date'],
                       housing_data_engineered[housing_data_engineered['county'] == county]['date']],
                 'type': 'scatter'}],
        'label': county,
        ''
        'method': 'update'
    }
    for county in counties
]

layout = dict(
   buttons = dropdown_buttons,
   direction =  'down',
   showactive = True,
   pad={"r": 10},
   yanchor="top",
   y=0.95,
   xanchor="left",
   x=1.05
)

fig.update_layout(margin=dict(t=100, b=50)) 

fig.update_layout(legend=dict(
    yanchor="top",
    y=0.99,
    xanchor="left",
    x=0.01,

))

fig.update_layout(
    updatemenus=[
        layout
    ]
)

# Add annotation for the dropdown
fig.add_annotation(
    text="County",
    x=1.15,  # X position of the annotation
    y=1.0,   # Y position of the annotation (adjusted to be slightly above the dropdown)
    xref="paper",  # Reference to the paper coordinate system
    yref="paper",
    showarrow=False,  # No arrow
    font=dict(size=12)  # Font size
)

# Update axis labels and title
fig.update_layout(
    title='Oregon County Rentals have Managed to Stay Affordable</i>',
    xaxis_title='Date',
    yaxis_title='Monthly Rental Payment (U.S. Dollars)',
)
fig.update_layout(yaxis_tickprefix = '$')
fig.update_traces(mode="lines", hovertemplate=None)
fig.update_layout(hovermode="x")
fig.update_layout(hoverlabel_namelength=-1)

# Show the plot
fig.show()
```

#### Project Design

After collecting as many statistics as we could and building our dataset, we created a design for the rest of the project.
To determine the strategies that could help the most with affordable housing, we did a 3-part analysis.

###### Strategy list, tagged with dataset associations
###### Found the best-fit multilinear model to each Oregon county and collected data about that set of features
###### To account for the non-linear aspect of our data, we fit a Random Forest model to each county and found associated feature importances

###### Visually show a venn diagram?  Discuss the intersection in the conclusions

##### Summary

In this study, we sought to identify dataset features associated with a set of researched housing strategies. First, 
we curated a list of relevant features and then narrowed it down by identifying those with the highest percentages of 
housing transactions that show significant linear associations with median sale prices. Next, we fitted linear models 
for each county to assess how these factors influence housing prices and in what direction.

To capture more complex, potentially non-linear relationships, we also employed a random forest machine learning model. 
This allowed us to evaluate the importance of each feature based on our original list of strategies.

These methodologies enable us to determine the most critical factors to focus on, such as increasing the housing supply, 
when formulating housing strategies.  Put simply, you can think of the design as a funnel where each step takes the next
logical progression in finding a set of strategy-associated features that affect the median sale price the most.

##### 1. Materials List (Software used) 

	1.  python v3.12.4	
	2.  sklearn	v1.5.1
    3.  SciPy v1.14.0
	4.  statsmodels v0.14.1
    5.  seaborn v0.13.2, matplotlib v3.9.0, and plotly v5.23.0 for visualizations
    6.  pandas v2.2.2 and numpy v2.0 for data manipulation
    7.  pymannkendall v1.4.3
    8.  OpenAI ChatGPT4 and Anthropic Claude3.5 Sonet

##### 2. Research and Identification of Core Strategies - A way to refine the dataset to targeted variables
Given the ultimate goal of this project to identify strategies that can help balance demand with the rising cost of housing, 
we began by conducting a comprehensive review of current strategies addressing housing affordability. This review aimed to 
identify the fundamental objectives of these strategies, such as increasing housing inventory, stabilizing rental prices, 
and enhancing accessibility for low-income households. The result of this review is a list of strategies and their respective 
goals, as detailed below.

To evaluate these strategies in relation to the data we collected, we needed to determine if any of the stated goals were 
directly or indirectly associated with our dataset. Initially, we attempted to make these associations ourselves, but 
recognizing our limitations as non-experts in housing policy, we sought assistance from AI tools. We utilized Anthropic’s 
Claude AI and OpenAI’s ChatGPT to analyze our dataset and tag each strategy goal with both direct and indirect associations 
to the dataset features. We found the intersecting sets of features curated from their responses were close in size to our original set.   
We therefore went forward with our analysis using this newly curated set. This approach also served as a validation step, 
ensuring that we had obtained some of the necessary data for the project.

For creating the AI prompt, we uploaded a CSV containing all data from our PostgreSQL database, a markdown file with the complete data dictionary, and a list of strategies and goals. The prompt used for the AI analysis was as follows:

"Using the attached dataset and data_dictionary.md data dictionary, identify direct and indirect associations between the strategy goals and the dataset features."

::: {.callout-note collapse="true"}
## Strategy Goal List - Click to Expand
| **Strategy/Goal**                                     | **Explanation**                                                                                                                        | 
|-------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------|
| **Inclusionary Zoning**                               | Policies require developers to include affordable housing units in new projects.                                                       |
| **Density Bonuses**                                   | Developers can build more units than normally allowed in exchange for including affordable housing units.                               |
| **Tax Increment Financing (TIF)**                     | Uses future gains in property taxes to finance current improvements, such as affordable housing developments.                           |
| **Low-Income Housing Tax Credits (LIHTC)**            | Provides tax credits to private developers for building or rehabilitating affordable rental housing.                                    |
| **Community Land Trusts (CLTs)**                      | Nonprofit organizations acquire and hold land to ensure it remains affordable for housing.                                              | 
| **Public-Private Partnerships**                       | Collaboration between government agencies and private developers to create affordable housing projects.                                 |
| **Rent Control and Stabilization**                    | Limits the amount by which rents can increase annually.                                                                                 |
| **Accessory Dwelling Units (ADUs)**                   | Smaller, independent residential units located on the same lot as a single-family home.                                                 |
| **Housing Vouchers**                                  | Programs like Section 8 provide subsidies to low-income households to help them afford rental housing in the private market.            |
| **Streamlining Permitting and Reducing Regulations**  | Simplifying the permitting process and reducing unnecessary regulations can lower the cost and time required to build housing.          |
| **Land Banking**                                      | Land banks acquire, hold, and manage vacant or underutilized land for future development of affordable housing.                         |
| **Increased Funding for Affordable Housing Programs** | Increasing funding for affordable housing programs can support the construction and maintenance of affordable units.                     |
| **Supportive Housing**                                | Combines affordable housing with on-site services to help individuals with special needs, such as those experiencing homelessness.      |
:::

::: {.callout-note collapse="true"}
## Anthropic Claud AI feature tagging output - Click to Expand
### Goals and Associated Features in the Dataset
| Strategy                                              | Direct Associations             | Indirect Associations                               |
|-------------------------------------------------------|---------------------------------|-----------------------------------------------------|
| **Inclusionary Zoning**                               | `new_listings`, `inventory`     | `median_sale_price`, `homes_sold`                   |
| **Density Bonuses**                                   | `new_listings`, `inventory`     | `median_sale_price`, `days_on_market`               |
| **Tax Increment Financing (TIF)**                     |                                 | `new_listings`, `median_sale_price`, `property_tax` |
| **Low-Income Housing Tax Credits (LIHTC)**            | `new_listings`                  | `inventory`, `median_sale_price`                    |
| **Community Land Trusts (CLTs)**                      | `median_sale_price`             | `inventory`, `average_sale_to_list`                 |
| **Public-Private Partnerships**                       |                                 | `new_listings`, `homes_sold`                        |
| **Rent Control and Stabilization**                    | N/A (primarily affects rentals) | N/A (primarily affects rentals)                     |
| **Accessory Dwelling Units (ADUs)**                   |                                 | `new_listings`, `inventory`, `median_sale_price`    |
| **Housing Vouchers**                                  | N/A (primarily affects rentals) | N/A (primarily affects rentals)                     |
| **Streamlining Permitting and Reducing Regulations**  |                                 | `new_listings`, `days_on_market`                    |
| **Land Banking**                                      |                                 | `new_listings`, `inventory`                         |
| **Increased Funding for Affordable Housing Programs** |                                 | `new_listings`, `inventory`, `median_sale_price`    |
| **Supportive Housing**                                |                                 | `new_listings`, `inventory`                         |

General observations:<br><br>
`population and num_housing_units`: Indirectly affected by many strategies<br>
`median_income`: Provides context for affordability<br>
`monthly_average_mortgage_rate`: Impacts overall affordability but not directly influenced by local strategies<br>
:::

::: {.callout-note collapse="true"}
## OpenAI ChatGPT feature tagging output - Click to Expand
### Goals and Associated Features in the Dataset
| **Strategy**                                | **Goal**                                                                                             | **Directly Associated Features**                                  | **Indirectly Associated Features**                             |
|---------------------------------------------|------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|----------------------------------------------------------------|
| Inclusionary Zoning                         | Increase the stock of affordable housing                                                             | `new_listings`, `inventory`, `median_sale_price`, `num_housing_units` | `median_income`, `population`, `property_tax`                  |
| Density Bonuses                             | Increase the overall supply of affordable units                                                      | `new_listings`, `inventory`, `median_sale_price`, `num_housing_units` | `median_income`, `population`, `property_tax`                  |
| Tax Increment Financing (TIF)               | Fund affordable housing projects                                                                     | `property_tax`, `median_sale_price`                               | `median_income`, `population`, `num_housing_units`             |
| Low-Income Housing Tax Credits (LIHTC)      | Increase the supply of affordable rental units                                                       | `median_sale_price`, `homes_sold`                                 | `median_income`, `population`, `property_tax`                  |
| Community Land Trusts (CLTs)                | Maintain long-term affordability                                                                     | `median_sale_price`, `inventory`                                  | `median_income`, `population`, `property_tax`                  |
| Public-Private Partnerships                 | Efficiently develop affordable housing                                                               | `new_listings`, `inventory`, `median_sale_price`                  | `median_income`, `population`, `property_tax`                  |
| Rent Control and Stabilization              | Preserve affordability                                                                               | `median_sale_price`, `days_on_market`                             | `median_income`, `population`, `inventory`                     |
| Accessory Dwelling Units (ADUs)             | Increase the supply of affordable rental housing                                                     | `num_housing_units`, `new_listings`                               | `median_income`, `population`, `property_tax`                  |
| Housing Vouchers                            | Make housing more affordable                                                                         | `median_sale_price`, `homes_sold`                                 | `median_income`, `population`, `property_tax`                  |
| Streamlining Permitting and Reducing Regulations | Encourage the construction of more housing units                                                     | `new_listings`, `inventory`, `days_on_market`                     | `median_income`, `population`, `property_tax`                  |
| Land Banking                                | Increase the supply of affordable units                                                              | `new_listings`, `inventory`, `median_sale_price`                  | `median_income`, `population`, `property_tax`                  |
| Increased Funding for Affordable Housing Programs | Develop, preserve, and subsidize affordable housing                                                  | `median_sale_price`, `homes_sold`, `new_listings`                 | `median_income`, `population`, `property_tax`                  |
| Supportive Housing                          | Stabilize vulnerable populations                                                                     | `median_sale_price`, `homes_sold`, `new_listings`                 | `median_income`, `population`, `property_tax`                  |
:::

<br>

##### 3. Data Exploration and Initial Analysis 

###### **Handling Different Types of Data and Choosing an Analysis Dataset**

We have several kinds of features in our dataset at this point:

* Data sourced through public websites
* Engineered Features
* Smoothed yearly data

When and how we use this data is an important aspect in our analysis and results.  We found our engineered features to be
very useful for determining trends and identifying when pricing became unaffordable, but those features were created
directly from other features in the set, obfuscating the raw data as indicators of housing prices.  We briefly left those
features in and found their significant correlation with the raw features to be detracting from getting a base-level 
understanding of what affects housing pricing.

Another important piece of our data is its time series aspect.  For Linear Regression analysis and the Random Forest model,
this data dimension is removed so that we can focus on what features correlate to housing prices, regardless of time.

After the analysis of the strategy list tagged with feature names, we chose a feature set to move forward and further
refine using various kinds of correlation.

###### **Handling Missing Data**

A review of our dataset revealed missing data in the following features: `new_listings`, `inventory`,  `days_on_market`, and `average_sale_to_list`.

A deeper inspection shows these values missing in the more sparsely Oregon counties, where home sales do not necessarily happen every month.  To handle
these, we decided to fill these with 0 values rather than drop the entire row.

In these sparsely populated counties, there are also fewer rows of home sales due to the fact that there are so few homes that sell in these areas.

##### 4. Identification of Significant Features 

###### **Correlation Studies**

Correlation studies gather evidence of association between our feature list and the median house pricing.  In this section, we look at
scatter plots, trend analysis, and linear regression exploration of each county in Oregon.

* **Scatter Plots**

Since the dataset is sectioned into counties, looking at scatter plots makes most sense when aggregating by counties.  Patterns
of correlation start to emerge when looking at county-aggregated cross-sections of the dataset.

Using Pairplot from the Seaborn library, we looked at bivariate scatter plots on the aggregated cross-sections to determine variable associations.  These
plots give an indications of whether linear regression could be a good first model.

* **Trend Analysis** 

All of our gathered data is time-series data.  It is important to explore the associated temporal trends in the data to identify 
what indicators of our feature set are significant and in what direction they are trending.  We used the Mann-Kendall seasonality
test to measure these trends by county for each feature in our feature set with an association to median sale price.

* **Linregress, a quick fit to measure significance**

We analyzed 36 counties in our dataset to identify which features have a significant association with the highest number 
of homes sold in Oregon. We developed an algorithm that uses the linregress from the SciPy Stats library and calculates 
the sum of the percentages of homes sold in each county where a feature is significant. For example, Washington County 
accounts for about 15% of all homes sold in Oregon during the period covered by our dataset. If a feature is only significant 
in Washington County, its representation among all homes sold in Oregon would be 15%. We set a p-value threshold of 0.05 for 
significance and required that significant features be present in at least 90% of home sales to be considered. See @fig-feature-sig below for more details.

![Feature Significance Representation in Oregon Home Sales](images/feature_significance.drawio.png){#fig-feature-sig width=300}

This further refined the set of features that we will consider for a multiple linear regression model.

* **Testing For Multicollinearity**

One potential factor that may lead to unexpectedly favorable results in a regression analysis is the presence of multicollinearity 
among the independent variables. To address this issue, we utilized the Variance Inflation Factor (VIF) from the Statsmodels 
library to evaluate all possible combinations of our remaining variables. By applying a VIF threshold of 10, we were able to 
identify viable sets of features suitable for inclusion in a multiple linear regression model. To ensure the robustness of our 
feature selection, we conducted this analysis on both the most and least populated counties.

##### 5. Building a Linear Regression Model

Our prior analysis identified a subset of feature combinations suitable for fitting a linear regression model. This 
subset was sufficiently manageable to allow us to fit linear regression models to all combinations. We then created 
training and testing datasets with a 70%/30% split and utilized Scikit-learn’s LinearRegression library to evaluate 
the performance of each combination.

By identifying models with a good fit, we were able to determine the relevant features and compare them with our random 
forest model. To ensure the validity of our models, we applied the Anderson-Darling test to verify that the residuals followed 
a normal distribution, which is crucial for evaluating the model’s fit. A p-value less than 0.05 in the Anderson-Darling 
test indicated that the residuals were not normally distributed for that particular combination of features.

Linear regression is an essential tool for understanding the magnitude and direction of a feature’s impact on the target 
variable. Our analysis revealed differences in model fit between densely populated and sparsely populated counties. We 
selected a representative county from each category to illustrate these differences. For each model fit, we measured the 
following values:

* R-squared
* Mean Absolute Error (MAE)
* Mean Squared Error (MSE)
* Root Mean Squared Error (RMSE)
* Mean Absolute Percentage Error (MAPE)
* Max Error
* Mean Squared Log Error
* Median Absolute Error
* Mean Poisson Deviance
* Mean Gamma Deviance

##### 6. Building a Random Forest Model

Random Forest machine learning models are advantageous for capturing the effects of features on a target variable more 
comprehensively than linear regression. Therefore, fitting a Random Forest Regressor model is beneficial. We employed a 
two-step approach: initially fitting the model to all strategy-tagged features and subsequently assessing feature importance 
to identify the most significant contributors. The model was then re-run using these key features.

We utilized Scikit-learn’s RandomForest library to train and test the dataset. Additionally, we employed the 
permutation_importance function from the sklearn library to determine the importance of various features. A Random Forest 
Regressor model was constructed and evaluated to validate these findings. For each county, we measured the following values:

* R-squared
* Mean Absolute Error (MAE)
* Mean Squared Error (MSE)
* Root Mean Squared Error (RMSE)
* Mean Absolute Percentage Error (MAPE)
* Max Error
* Mean Squared Log Error
* Median Absolute Error
* Mean Poisson Deviance
* Mean Gamma Deviance

We were then ready to compare and contrast our feature findings.